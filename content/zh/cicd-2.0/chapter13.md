## 13.4 生產環境測試

- 生產環境是獨一無二，我們永遠無法1保證發現生產環境中可能出現的所有問題。
- 隨著軟體快速發佈訴求的提升，非生產環境的測試場景越來越顯得不充分。
- 如何在不影響生產的前提下，在生產環境中進行測試？

### 13.4.1 測試活動扁平化趨勢

- 傳統的混布式軟體開發方法中，測試執行和決策活動通常集中在軟體研發周期的中部。
- 隨著現代軟體交付頻率的不斷加快，這種情況出現了變化。很多團隊的測試活動開始向左右兩側移動，如圖13-7所示。
![13-7-測試活動的左右移動.png](images/cicd-2.0/13/13-7-測試活動的左右移動.png)
- 測試左移(測試前移)，是指測試人員更早且積極地參與到軟體專案前期各階段活動中，在開發功能之前就定義相關的測試案例。
- 測試執行任務也在向左移動，表現為 : 在越來越多的軟體團隊中，測試角色開始擁抱「增量測試」，即在軟體整合測試之前，就開始針對單個已開發完成的功能集進行品質驗證，提前發現品質風險。儘管這種「增量測試」無法發現全部品質問題，但可以減少整合測試階段的時間壓力，如圖13-8所示
![13-8-0-測試左移.png](images/cicd-2.0/13/13-8-0-測試左移.png)

#### 測試左右移動

- 「測試右移」是指將一部份品質驗證工作放在軟體發布之後，也就是讓子彈飛一回兒。
- 主要因為網際網路軟體產品的測試，與原先企業內部應用的軟體測試有顯著不同，即無法窮舉性。
- 企業內部軟體的使用者有限，環境相對可控, 但網際網路產品的情況有所不同，每個人的電腦或手機上都安裝著不同的軟體，硬體與作業系統也有很多種組合，因此無法以窮舉方式進行所有相關場景測試。因此大家也越來越依賴於生產環境上的品質驗證
- 測試右移現象多見於軟體產品中的示範性功能(software for show)，即軟體功能更多地傾向於內容展示，例如搜尋軟體、拍照軟體、商品展示。即便這類功能出現一些問題，但只要即時發現即時修復，就不會對用戶造成本質性損失或嚴重影嚮。
- 對事務性軟體(software for transaction)以及問題修復成本較高的軟體(firmware)來說，一但生產環境出現問題，會帶來比較大的損失。因此軟體團隊不會冒險將功能驗證的活動右移，而是有強列的動機將測試活動盡可能左移，同時加強右測的監測能力。


### 13.4.2 生產環境中的測試

- QA部份應將生產環境中的測試列入日常工作中，稱為「生產巡檢」。
- 對生產環境中的後台服務進行定期功能驗證，以確保該後台服務備舊對外正常提供服務，且處理的結果是正確的。
- 通常的做法是：建立一個覆蓋應用程式主要功能的日常健康檢查清單，對生產環境進行例行測試和檢查軟體服務的品質。這種測試方法與監測不同，它們是由軟體團隊自行安排的品質驗證工作，並且定期執行，因為這是一些例行驗證，所以應該被自動化執行．。這類測試中最典型的就是介面測試。
- 很多團隊開始將一些自動化介面測試的案例放在生產環境鞏，周期性執行，以代替手動檢查。
- 這類生產環境上的品質保障工作應遵循以下原則
    1. 建立自用的測試資料，確保不污染真實用戶的資料
    1. 使用的測試資料盡可能真實
    1. 不要隨便修改真實用戶的資料
    1. 建立測試專用的用戶存取憑證，登錄生產環境

### 13.4.3 混沌工程

- 混沌工程(chaos engineering)是指在生產環境中注入「問題」，進而發現生產環境系統性弱點，並進行系統性改進的方法或手段。
- 其目標是不斷提升生產環境面對任可變更的可靠性。這與疫苗注射類似，向系統注入一些小劑量的「病毒」使身體康立對它的抵抗力，進而使身體獲得免疫性。
- 此部份最有名的例子為Netfilx的[Simon Army](https://github.com/Netflix/SimianArmy)
![13-8-1-Simian Army.png](images/cicd-2.0/13/13-8-1-Simian Army.png)
- Netflix在AWS上，開發了一系列生產環境測試工具，稱為Simon Army，用於模擬AWS如區(zone)或大區(region)出現問題，以及模擬人為製造呼叫延遲，用來模擬服務降級，看依賴這些服務的模組是否能正確做出反應。
- 這種問題注入(Failing Injection)式的主動檢測，可使軟體工程師在架構設計上就需考慮一些常見的失敗問題。

## 13.5 向東，還是向西

![13-9-向東，還是向西.png](images/cicd-2.0/13/13-9-向東，還是向西.png)

- 快速驗證環中，我們將精練後的試驗方案變為可執行的軟體，部署到生產環境，並且收集了執行結果和用戶回饋。現在是要決定下一步「向東，還是向西」以完成第一個業務閉迴圈
- 透過分析總結，可幫助我們從收集到的數據中來判定前進目標
- 若收集的結果不合預期，只要與團隊共同分析，看是針對現行方案進行微調，還是從備案中選擇新的試驗方案，繼續驅動這個快速驗證環


## 13.6 小結

### 生產環境的監測範圍包含三個層次 :
1. 基礎監測
1. 應用監測
1. 業務監測
 
每個層次的特點，監測資料的採集方式有所不同，但其處理流程基本一致，包括:
資料收集、上報、整理、分析、展現與決策這幾個環節

### 而對監測系統能力的衡量有3個維度 : 

1. 資料的準確性 
1. 全面性 
1. 即時性

- 告警處理是研發人員和維運人員的常規工作，但告警過多反而會造成工作中的困擾，降底工作產出。因此我們應該不斷對告警點的設置及臨異值計算方式進行最佳化，進而盡可能提升有效告警率。一但告警成立，就需要啟動問題處理流程。這個流程的最後兩個環節 「根因分析」和「根源解決」是學習型組織的重要特徵
- 隨著發佈頻率的提高，測試場景的複雜性提高，越來越多團隊開始找尋方法在生產環境上進行軟體測試，這被稱為測試活動右移。這種只適用於軟體出錯後的成本和影嚮相對較少。而那些較交易性軟體或回收成本較高的軟體來說，測試左移的趨勢也較明顯。

### 測試右移主要有兩種類型 :
1. 將測試案例在生產環境上自動執行
1. 混沌工程(Chaos engineering)
- Netfilx開發了一系列破壞性測試工具(Simian Army)可以促使工程師在軟體設計與開發之時，就提前考慮各種失敗的可能性，這被稱為「為失敗而設計」進而提高生產環境的軟體服務穩定性，為用戶提供更好的服務體驗。

- 當收集到真實的資料回饋，就可印證在價值探索環中所提出的假設或目標，並透過主動關聯分析，最終確定是繼續進行更多的試驗，還是重新再選擇一條新的路
