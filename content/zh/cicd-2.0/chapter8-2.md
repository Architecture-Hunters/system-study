---
title: 'Chapter 08-3 分支模式的演化 ~ 08-5'
description: 'Chapter 08-3 分支模式的演化 ~ 08-5'
position: 103
category: 持續交付2.0：實務導向的DevOps
menuTitle: 'Chapter 08-B'
---

# 分支策略

# 8.3 分支模式的演化

### 8.3.1 三駕馬車分支模式

Chrome 瀏覽器於 2010 年使用此分支模式

![8-13](images/cicd-2.0/08/8-13.png)

開發 Branch 擁有足夠多的新功能 (或者準備 Release 時), 將該 Branch 使用 `Cherry Pick` 撿到 Pre-Release 分支上

Pre-Release

- BugFix
- Document
- Deployment
- Feature

Pre-Release 達到 Alpha 等級後 → 發布Alpha 版本 (給予極少部分使用者先行體驗) → Beta 版本 (給予嘗鮮用戶進行體驗) → 收集存在的質量與 Bug 問題與修正  → Beta 版本穩定 → 合併至 Release 分支 → RC 版本 → RC 版本穩定 → 正式版本

### 8.3.2  GitFlow

1. `Master` (Main) 分支是正式版本的發布分支
2. `Release` 分支用於品質打磨的預發布分支，如果 Release 的品質達標，將 Release 合併至 Main 分支與 Development 分支
3. `Development` 分支為 Feature 新功能整合的分支
4. `Feature` 分支是為了新的功能，開發人員從 Development分支上 Checkout 出來的分支。當 Feature 開發完後，合入 Development 分支。

![8-14](images/cicd-2.0/08/8-14.png)

Gitflow 為特性分支模式與三駕馬車分支模式的組合

- 優點: 分支定義明確
- 缺點: 分支較多，具有特性分支的不足

### 8.3.3 GitHubFlow

- 名稱來自 GitHub 團隊的工作實現
- 對於開發者的開發紀律比較嚴格，對於品質保證的要求也較高。

### Flow

1. 從 Master (Main) 建立一個新分支, 以特性 (Feature) 或 缺陷 (Bug) 的編號 (Issue Number) 命名該分支。
2. 在這個新分支上撰寫並提交程式碼。
3. 功能開發完成後，並自行測試通過，建立 Pull Request (簡稱 PR)
4. 其他開發人員對這個 PR 進行審查 (Code Review)，確保程式碼品質沒問題後，合併回 Master (Main)

![8-15](images/cicd-2.0/08/8-15.png)

如果 Feature 分支存在時間很短，則此模式可被認為是高頻率的 `主線開發，主線發布` 的模式。

---

# 8.4 分支策略

企業可以依照以下類型與條件，來確定適合團隊的分支方式

- 開發或維護的軟體產品類型
- 發布的頻率
- 團隊成員能力
- 基礎架構的等級
  - 自動化測試
  - 程式運行環境的管理
  - 團隊紀律性

### 8.4.1 版本發布模式

版本發布的基本模式有三種:

- 專案制發布模式 ( Project Release Mode )
- 發布火車模式 ( Release Train Mode )
- 城際快線模式 ( Intercity Express Mode)
1. **專案制發布模式**

在軟體研發規畫中，先確認好某一版本需要的功能特性數量，只有當該次版本所需的功能全部開發完成並達到相對應的品質標準後，才能發布該版本。

發布版本的時間間隔並沒有強制的規定，而是根據新版本要求的功能集合開發完成並達到發布標準後，對所需的時候進行評估後決定。

此模式為最古老的發布模式，針對一個特定版本，確定了版本的功能數量與品質標準後，再估計版本交付的週期，等於先固定了功能數量與品質要求，因此團隊可能交付的時間點也就相對固定。

Pros:

- 可以確切知道每個版本包括哪些具體功能，有利於商業套裝軟體的銷售模式 (賣版本和授權，收取維護費用，當有心功能版本發行後，再向客戶收取新版本的升級費用。
- 符合人們的安全生產習慣，也就是不能把未完成的功能帶到即將發布的版本中。

Cons:

- 專案交付周期較長，參與人員眾多
- 如果開發週期因為某些原因導致需求變更 (如增加需求、修改原本需求實作方式或更換需求) 時，需要重新評估專案的交付時間，會連動影響那些原本能夠如期交付的需求。
- 需要等待所有需求全部實現完成後才能一起發布
1. **發布火車模式**

常見於大型套裝軟體。大型傳統軟體產業通常有許多產品線，各產品線之間存在非常複雜的相互依賴關係。為了能夠讓各個產品線協同發布。這些企業會為每條產品線都制定好每個版本的發布週期，也就是每個版本都像火車一樣，事先計畫好什麼時候發車。

<aside>
💡 車是按照時間發的，能趕上火車的就一起走，趕不上車的，就等下一班車。

</aside>

![geton](images/cicd-2.0/08/geton.jpg)

為了能夠準時發布，要求所有參與到該版本的開發團隊必須對齊該版本的每個開發階段。這種嚴格的時間一致性要求是因為如果該產品線的時間變更會引起其他產品線的時間變更，而這些更改也可能會影響到共享的集成測試環境的分配。

大多數的情況下，由於計畫和各產品集成與依賴關係，因此發布火車通常以一季為單位，但不會超過 10 個月。( *Note: 本書作者以大型企業來做舉例，但 Release Train Mode 不一定依照此週期為規範。)

當發布火車時間表時，發布管理團隊通常與負責個產品開發的團隊進行提前溝通，討論要發布那些內容，有時甚至需要幾個月的時間，將其結論發布在企業版本表中。

![Untitled](images/cicd-2.0/08/8-17.png)

圖 8-17 為 LiberOffice 的發布火車時間表。提前制定出時間，目的就是讓各種業務與技術部門有足夠多的時間進行計畫，以便評估出各種依賴與影響。

制定發布計畫是一個ˊ非常正式與結構化的過程，需要有各種格式化數據以確保參加的團隊能夠對正式發布的可行性做出判斷。數據包含發布的詳細資訊( 相對標籤、名稱、部屬日期、風險級別、發布類型-企業,計畫或投資組合)、整個生命週期的各個階段及預定日期(如圖 8-18 )、每個階段要完成的活動與任務、里程碑時間、品質要求、以及管理發布火車的主要負責人。

![Untitled](images/cicd-2.0/08/8-18.png)

Pros:

- 對於企業來說，可以通過並行多台車的方式，將突發需求排入一台發布火車
- 用戶可以提前體驗最新版產品提供的新特性，而不必影響原本生產線上的舊版本。體驗之後在決定要不要應用於自己的生產環境中
- 即便已經決定將這個新版本用於自己的生產環境中，也可以等到新版本成熟穩定之後再這麼做

Cons:

如果參與團隊的人數越多，溝同協調的成本會越高

**3 城際快線模式**

城際快線模式是指在發布模式三要素中，固定 `時間` 與 `品質` 兩個維度，且時間周期較短(一周，一天，甚至更少)，針對那些在0發布時間點已達到對應品質標準的特性進行一次發布。

跟火車發布的區別在於兩點:

1. 發布周期較短，通常是兩周以內
2. 負責功能開發的團隊可以自己選擇搭乘哪台城際快線，而不必在很久之前就先確定把時間確定下來。

這種模式常見於提供網際網路服務或 SaaS 服務的軟體公司。好處在於減少了團隊之間溝通協調成本。因為每個人都知道每次發布的具體時間點，所有工作任務都可以按照這個時間點提前進行協調。而且即使功能沒有及時趕上最近一次的版本發布，團隊也能知道這個功能是否可以在下一次發布的時間進行發布。Facebook 的 Web 網站於 2013年部屬推送頻率以達到每天發布兩次，每周一次大版本。如圖 8-19 所示。

![Untitled](images/cicd-2.0/08/8-19.png)

每個周日從主幹上拉一個發布分支，自動化測試驗證通過後，在公司內部人員開放(在公司內訪問，重定向到 latest.facebook.com)。運行過程中如果出現問題，可以在主幹上修復，然後分撿到 (CherryPick) 發布分支上。發布分支上代碼每天兩次更新到 latest.facebook.com，供公司員工內部開發使用。如果版本穩定，就對外發布，同樣是每天兩次。

自 2017 年開始 Facebook 的發布策略已經從一天兩次的"主幹開發，分支發布" 改變為平均每天發布 9~10 次的 "主幹開發，主幹發布"模式。

城際快線模式的優點有兩個:

1. 每個人都非常清楚各個時間點
2. 更加聚焦生產品質

缺點:

1. 發布頻率較高，因此未完成功能的代碼也會一同發布出去
2. 對於程式碼要求品質較高，需要強大的品質基礎設施保證。

使用城際快線模式，間隔多長時間發出一趟合適? 在不影響用戶體驗，不增加成本且合規的前提下，讓發布週期盡可能縮短到令你感到有些緊張的節奏，例如:每個月發布一次版本，現在可以把兩周當作一個目標。

### 8.4.2 分支策略與發布周期的關係

> 分支策略與版本發布周期有一定的相關性
>

![Untitled](images/cicd-2.0/08/8-20.png)

分支策略與版本發布周期之间有一定的相關性，如圖 8-20 所示

- 軟體開發週期極長的“專案制”團隊和軟體發布頻率的極高 “城際快線模式”團隊會使用 `主幹開發，主幹發布` 的分支策略
- 次之的團隊會使用 `主幹開發，分支發布` 的策略
- 最後的區間使用 `分支開發，主幹發布` 的分支策略
- 這之間不是絕對的，其中會有很大的重疊部分，通常會受到團隊成員人數，產品架構與品質保障基礎設施等影響

## 8.5 小結

每個分支策略都有其優點與挑戰。它對於發布頻率以及每次發布的效率也有較大的影響。

目前的發展趨勢為: 軟體的發布的頻率越來越高，發布週期越來越短，矽谷頂級的網路公司大多採用 "主幹開發" 或者高頻的 `GitHub Flow` 分支模式。

一個企業到底選擇哪種分支策略，需要依據團隊的具體情況來決定。如果相對應的基礎設施不足 ( 如軟體架構、人員能力、和工具平台成熟度)，盲目地提高發布頻率，縮短發布週期會造成不必要的損失。

“持續交付 2.0” 提倡持續極盛的分支策略，選擇分支模式的原則有以下幾項:

1. 分支越少越好，最好只有一條主幹
2. 分支生存週期越短越好，最好在 3 天以內
3. 在業務允許的條件，發布週期越短越好。

企業管理者應該遵循 “持續交付 2.0”  的思想、理念與原則。制定合理的改善目標，促進公司 IT 交付能力不斷提升，才能夠跟上時代的發展。

## Additional Reference:

[Git 常用的分支管理模型](https://zhuanlan.zhihu.com/p/377812978)

[DevOps 技术：主干开发](https://cloud.google.com/architecture/devops/devops-tech-trunk-based-development)

[什么是Release Train?](https://zhuanlan.zhihu.com/p/60229527)