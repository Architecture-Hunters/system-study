---
title: 'Chapter 07 部屬流水線原則與工具設計'
description: 'Chapter 07 部屬流水線原則與工具設計'
position: 101
category: 持續交付2.0：實務導向的DevOps
menuTitle: 'Chapter 07'
---
## 前言
Deployment Pipeline為CI的核心，能完整呈現軟體交付的整個過程。從程式碼完成後的提交、建構、部屬與測試到正式的發布，除了可以清楚知道整個歷程外，也可即時得知提交進度。

那我們該如何根據團隊與不同產品去設計整個Pipeline?此章的重點就在談這件事情。 

<alert>
部屬Pipeline受到軟體架構、Git Flow及團隊與產品不同而有所不同設計概念。
</alert>

## 7.1 簡單的部屬流水線
此節以實際例子來簡易OverView在Pipeline設計上會有那些環節與實際情境。書中例子以[Curise](https://reurl.cc/Dydonj)為範例，他就像今日我們很常聽到Jenkis，是一個j以Java Base開發的持續整合工具。其程式碼高達5萬行，而自動化單元測試及整合測試Case就多達2350個，端對端測試為140個，在架構也算蠻龐大的軟體系統。

但他在2010年就停止維護了，有興趣了解可以到他的[官方網站](https://reurl.cc/ank4v9)。Curise在2010年停止維護後更名為GoCD，並走Open Source開發。並將Source Code放置[Github](https://github.com/gocd/gocd)。

### 7.1.1 GoCD簡單的產品研發流程

GoCD算典型的持續整合代理伺服器架構，其架構如下，GoCD Server提供使用者UI及Pipeline腳本控制及指派工作，讓Agent去執行Pipeline過程中需要執行的Command(此處簡單帶過)。另外一提，他使用的版控工具為Mercurial不是一般主流的Git。

![001](images/cicd-2.0/07/001.png)

維護此產品的團隊人數約為12人，產品的交付其中與迭帶週期為一周。在這麼快速的迭帶週期，團隊也使用CICD，在每個迭帶結束後，用新版本替換掉目前團隊在使用的舊版本，並在每兩個迭帶後將試用版本部屬到公司內部的公用伺服器，若公司內部試用版本使用到一個品質檢測標準，一周後再將版本交給企業試用。其週期如下圖所示，

<p align="center">
  <img src="images/cicd-2.0/07/002.png" width="100%" /> 
</p>


### 7.1.2 初始Pipeline設計

GoCD的Pipeline設計是Base on六步提交法理論，六步如下

 - 第一步: Clone成功版本至本地端 
 - 第二步: 修改程式碼
 - 第三步: 本地端Build && Test
 - 第四步: Merge其他人程式碼再跑一次Build && Test
 - 第五步: 提交
 - 第六步: 進Pipeline

<p align="center">
  <img src="images/cicd-2.0/07/003.png" width="100%" /> 
</p>

感覺六部提交法是針對新的小碼農制定的口訣，避免小碼農Clone錯誤的程式碼或是沒有做好Build Test就提交程式碼，會Focus在個人建構部分。

我們來看GoCD的Pipeline設計如下圖，整個提交整合與部屬分為八個Stage站別，有手出現的Icon代表人為去介入

<p align="center">
  <img src="images/cicd-2.0/07/004.png" width="100%" /> 
</p>

基本上每個站別都只有一類任務類型，

 - 1.提交建構:Build 與 單元集成測試
 - 2.次級建構:End To End 測試(Windows && Linux)
 - 3.將打包好的檔案部屬到UAT環境
 - 4.測試人員驗證完後Tag驗收通過，並對Pipeline點擊繼續
 - 5.做自動化性能測試(此處沒說明做什麼性能測試)
 - 6.將Alpha版本部屬到公司內部伺服器給團隊試用
 - 7.試用OK後發布Beta版本給外部企業試用
 - 8.外部企業試用試用完成後正式發布

<alert>
UAT，(User Acceptance Test),使用者接受度測試 即驗收測試，主要是用來作為客戶體驗的環境。
</alert>

基本上這Pipeline設計大部分專案情境可能都會經過這些步驟，只是也許後面部屬與測試順序不一定會完全相同。例如有些企業會覺得UAT測試完後其實就可以上Production，但GoCD為了嚴謹在部屬測試上又多了好幾個站別，確保Product能完全運行順利。

另外值得一提的，在這個設計中，GoCD在單元集成測試的時間非常長，有五個集成測試，基本上每個集成測試要花15min，而第二站別的次級建構端對端測試也多達140個測試項目，需要最長時間為30min....

### 7.1.3 Pipeline狀態解析

管線運型實際狀況如下，可看到在建置編號12版本，在UAT部屬就停了下來。也許這建置版本並沒有新功能，所以可以在這階段就停止。而建置編號13在次級建構跳過，有可能因為12還沒完成。至於此處是手動按停止還是自動停止就不太清楚。

不過此節要表達的是，再多Job管線運行上，會根據不同狀況管線過的Stage狀況也會不太一樣。

<p align="center">
  <img src="images/cicd-2.0/07/005.png" width="100%" /> 
</p>


## 7.2 Pipeline的設計與使用

在介紹完GoCD Pipeline的實際使用狀況，大體上應該會曉得基本Pipeline會有什麼工作需要運行。那我們該如何透過設計去優雅的使用Pipeline呢?

### 7.2.1 Pipeline的設計原則

書中提到有5個觀念去設計Pipeline

#### 第一個觀念、一次建構，多次使用

若Pipeline上的任務要產生部屬使用的檔案，盡量在前面的站別就一次建構完成，並可直接讓後面的站別做使用。盡量不要在後面在別再做重複性建構。另外如果後續的站屬如果要使用此編制檔案，也必須此部屬檔案來源是與上流站別是同一份。

#### 第二個觀念、與業務邏輯松耦合

簡單來說在就是不要為了方便，將一些部屬所需使用的腳本或資料放在Pipeline Server上，盡量與Pipeline Server不要有編譯耦合的設計。相反，若有相依檔案或腳本，我們必須存放在存取庫中，照樣就可以輕鬆對這些腳本設計做修正。

簡單來說，對於Pipeline，他就像是調度、執行與紀錄者，他只需要知道整個調度流程，不需要知道如何建構與部屬軟件需要自己提供哪些東西。

#### 第三個觀念、並行化原則

如果有五個自動化測試任務，我們也可以設計並行Pipeline同步跑這五個測試任務，並即時提供結果訊息，從而修正問題。若使用併行，整體等待回應的時間就能大幅收短。就像前面提到GoCD有五個測試集成，若使用並行化原則就能大幅縮短測試時間。

#### 第四個觀念、快速回應結果
如果資源較貧乏(例如Runner規格特爛)，在Stage的設計，我們可以將依些運行較快的自動化驗證優先做執行，較慢與消耗資源較多的放在後面執行。感覺這邊得意思 花較長時間的測試，就放在越接近正式上線前做，來縮短前面開發測試時間。

#### 第五個觀念、重要的回應結果優先
呼應第四點，雖然為了達到快速回應結果將一些較快的測試放在前面做，但依然要以重要優先權高的為主。


### 7.2.2 團隊紀律

#### 第一個觀念、立即暫停原則
Pipeline一出問題，團隊需要有人立即去處理，而不是放任他不管。再問題修復前，禁止任何人提交新的程式碼。

#### 第二個觀念、安全審核原則
所有代碼與軟件包都需要有偷過板控及審核完畢才可使用。


## 7.3 Pipeline平台的組成

這章節主要述說Pipeline的主要組成區塊

### 7.3.1 工具鏈整體架構

書中提出的圖有點難去了解，在這我拿一張以Github結合Jenkis的架構圖去輔佐解說(Jenkis那張圖先不管架構Solution是否為最好)。

![006](images/cicd-2.0/07/006.png)

Pipeline整體架構主要分成、唯一信受源(程式碼與打包物存取庫)、調度及展示(調度器)以及基礎支撐服務(測試、部屬等實際執行環境..)

#### 唯一信受源
在Pipeline過程中，團隊角色若對任何訊息產生質疑時，要做追溯都應該要能追回到存取庫裡的產出物(要部屬檔案)，而在存取庫中的打包檔案都可以找到對應程式碼及他相依的類別庫檔案，或是能找到下載的URL Source。

#### 調度及展示(Pipeline)
能接受不同的服務基礎平台，且具有調度不同任務，完成整個交付流程的功能。並此能展示整個過程的歷史訊息。

#### 基礎支撐服務
一間較大的公司具有相對應的建構、測試及部屬的服務。規模較不大的通常前兩個通常就直接在一個Runner Execute直接做掉。那如果是前者，在Pipeline設計上就要考慮如何去與這些基礎支撐服務去連通與協作，讓整體Pipeline過程中達到最大的效益性。

### 7.3.2 平台應具有的基本能力

Pipeline事團隊多角色的統籌協作系統，因此關注的是軟體在Pipeline的流動效率，包含部屬與上線，過程能精準展現個環節的狀態與訊息，並能在不增加團隊負擔情況下自動收集各環節產生的數據。例如，衡量某一功能的開發週期。

此章節提到重點就下述兩點，

 - 1.追溯能力
 - 2.重新建構能力

針對1不多說，簡單來說就是對於事件能查詢他所有的歷程。對於2，只要存取庫程式碼依舊存在，就算遇到版本出問題，依舊能再次修改重新做自動部屬。又或是自動化失敗因為對應服務環境出問題，在對應環境Recovery後，能再次重新運行測試。

### 7.3.3 工具鏈建設策略
上述7.3.1圖中提到的平台架構，可看出他是由不同的工具與子系統組成。因此我們可以根據公司的習慣與策略去客製設計。例如GoCD團隊因為在自動化測試量較龐大，因此就自行開發一個自動化測試分組插建，由此插件自動將所有測試分配到不同任務哩，並將這些任務分配到多個測試環境中執行。但對更大型的公司，其環境會更加複雜，其各產品組件之間的關聯關係也會更加龐大複雜。為了發揮持續交付的威力，上述提到的各類支撐服務雲端化也成為必要選項。例如AWS、Facebook與Google都具有自己的DevOps平台工具鏈，甚至將其中一部分工具開放給Open Source。

那此服務系統間個詳細的關係是什麼? 7.4章節會述說這件事情。

